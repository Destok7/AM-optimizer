<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Dashboard ‚Äì LPBF Optimizer</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div class="app-layout">

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <h2>‚öôÔ∏è LPBF Optimizer</h2>
            <p>Produktionsplanung</p>
        </div>
        <div class="sidebar-nav">
            <a href="/static/dashboard.html"     class="nav-item active"><span class="icon">üìä</span> Dashboard</a>
            <a href="/static/inquiry.html"        class="nav-item"><span class="icon">üìã</span> Anfragen</a>
            <a href="/static/buildjobs.html"      class="nav-item"><span class="icon">üèóÔ∏è</span> Build-Jobs</a>
            <a href="/static/nesting.html"        class="nav-item"><span class="icon">üî≤</span> Nesting</a>
            <a href="/static/notifications.html"  class="nav-item"><span class="icon">‚úâÔ∏è</span> E-Mail-Entw√ºrfe</a>
        </div>
        <div class="sidebar-footer">
            <span id="user-name">Benutzer</span>
            <a href="#" onclick="logout()" style="color:rgba(255,255,255,0.4);font-size:12px;text-decoration:none;">Abmelden</a>
        </div>
    </nav>

    <!-- Main -->
    <div class="main-content">
        <div class="topbar">
            <h1>Dashboard</h1>
        </div>
        <div class="page-body">

            <div class="stats-grid" id="stats-grid">
                <div class="stat-card"><div class="stat-value" id="stat-pending">‚Äì</div><div class="stat-label">Offene Anfragen</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-combined">‚Äì</div><div class="stat-label">Kombinierte Anfragen</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-jobs">‚Äì</div><div class="stat-label">Aktive Build-Jobs</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-drafts">‚Äì</div><div class="stat-label">E-Mail-Entw√ºrfe</div></div>
            </div>

            <!-- Open Build Jobs -->
            <div class="card">
                <div class="card-title">üèóÔ∏è Offene Build-Jobs ‚Äì Plattformauslastung</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Job-Name</th>
                                <th>Status</th>
                                <th>Auslastung</th>
                                <th>Verf√ºgbare Fl√§che (cm¬≤)</th>
                                <th>Anfragen</th>
                                <th>Gesamtpreis</th>
                            </tr>
                        </thead>
                        <tbody id="jobs-table-body">
                            <tr><td colspan="6" style="text-align:center;color:var(--text-muted)">Lade Daten...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Inquiries -->
            <div class="card">
                <div class="card-title">üìã Neueste Anfragen</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Anfragename</th>
                                <th>Kundennr.</th>
                                <th>Bauteil</th>
                                <th>Menge</th>
                                <th>Status</th>
                                <th>Gesch√§tzter Preis</th>
                                <th>Datum</th>
                            </tr>
                        </thead>
                        <tbody id="inquiries-table-body">
                            <tr><td colspan="7" style="text-align:center;color:var(--text-muted)">Lade Daten...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="/static/js/auth.js"></script>
<script>
    requireAuth();
    setUserName();

    async function loadDashboard() {
        // Load inquiries
        const inqRes = await apiFetch('/api/inquiries/');
        if (!inqRes) return;
        const inquiries = await inqRes.json();

        const pending  = inquiries.filter(i => i.status === 'pending').length;
        const combined = inquiries.filter(i => i.status === 'combined').length;

        document.getElementById('stat-pending').textContent  = pending;
        document.getElementById('stat-combined').textContent = combined;

        // Recent 10
        const recent = inquiries.slice(0, 10);
        const inqBody = document.getElementById('inquiries-table-body');
        if (recent.length === 0) {
            inqBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted)">Keine Anfragen vorhanden</td></tr>';
        } else {
            inqBody.innerHTML = recent.map(i => `
                <tr>
                    <td><strong>${i.inquiry_name}</strong></td>
                    <td>${i.customer_number}</td>
                    <td>${i.part_name}</td>
                    <td>${i.quantity}</td>
                    <td>${statusBadge(i.status)}</td>
                    <td>${formatCurrency(i.estimated_part_price_eur)}</td>
                    <td>${formatDate(i.inquiry_date)}</td>
                </tr>
            `).join('');
        }

        // Load build jobs
        const jobRes = await apiFetch('/api/buildjobs/');
        if (!jobRes) return;
        const jobs = await jobRes.json();

        const activeJobs = jobs.filter(j => ['open','planned'].includes(j.status));
        document.getElementById('stat-jobs').textContent = activeJobs.length;

        const jobBody = document.getElementById('jobs-table-body');
        if (activeJobs.length === 0) {
            jobBody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">Keine aktiven Build-Jobs</td></tr>';
        } else {
            jobBody.innerHTML = activeJobs.map(j => {
                const fillClass = j.fill_percent >= 90 ? 'full' : j.fill_percent >= 60 ? 'warn' : '';
                return `
                <tr>
                    <td><strong>${j.job_name}</strong></td>
                    <td>${statusBadge(j.status)}</td>
                    <td>
                        <div style="display:flex;align-items:center;gap:8px">
                            <div class="progress-bar" style="width:120px">
                                <div class="progress-fill ${fillClass}" style="width:${j.fill_percent}%"></div>
                            </div>
                            <span style="font-size:13px">${j.fill_percent}%</span>
                        </div>
                    </td>
                    <td>${formatNumber(j.available_xy_surface_cm2)}</td>
                    <td>${j.inquiry_count}</td>
                    <td>${formatCurrency(j.total_price_eur)}</td>
                </tr>`;
            }).join('');
        }

        // Load notifications
        const notifRes = await apiFetch('/api/notifications/?status=draft');
        if (!notifRes) return;
        const notifs = await notifRes.json();
        document.getElementById('stat-drafts').textContent = notifs.length;
    }

    loadDashboard();
</script>
</body>
</html>
