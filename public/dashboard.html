<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard â€“ AM-Optimizer</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div class="app-layout">
    <div id="sidebar-container"></div>
    <div class="main-content">
        <div class="top-bar">
            <h1>Dashboard</h1>
            <span id="username-display" style="font-size:13px;color:#718096;"></span>
        </div>
        <div class="page-body">
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-label">Anfragen in Datenbank</div>
                    <div class="stat-value" id="stat-inquiries">â€“</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Davon AuftrÃ¤ge</div>
                    <div class="stat-value" id="stat-orders">â€“</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Kombinierte Kalkulationen</div>
                    <div class="stat-value" id="stat-calcs">â€“</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">E-Mail-EntwÃ¼rfe</div>
                    <div class="stat-value" id="stat-emails">â€“</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">ML-Modell Status</div>
                    <button class="btn btn-primary btn-sm" onclick="trainModels()">
                        ðŸ§  Modelle trainieren
                    </button>
                </div>
                <div id="model-status-table">Lade...</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Letzte Kalkulationen</div>
                    <a href="/kalkulation.html" class="btn btn-outline btn-sm">Alle anzeigen â†’</a>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Kalk.-Nr.</th>
                                <th>Name</th>
                                <th>Maschine</th>
                                <th>Material</th>
                                <th>Orig. Preis</th>
                                <th>Kalk. Preis</th>
                                <th>Ersparnis</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recent-calcs-body">
                            <tr><td colspan="8" style="text-align:center;color:#718096">Lade...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/auth.js"></script>
<script src="/static/js/app.js"></script>
<script>
checkAuth();
document.getElementById('sidebar-container').innerHTML = renderSidebar('dashboard');
document.getElementById('username-display').textContent = localStorage.getItem('username') || '';

async function loadDashboard() {
    try {
        const [inquiries, calcs, emails, mlStatus] = await Promise.all([
            apiFetch('/api/datenbank/'),
            apiFetch('/api/kalkulation/'),
            apiFetch('/api/emails/'),
            apiFetch('/api/ml/status'),
        ]);

        document.getElementById('stat-inquiries').textContent = inquiries.length;
        document.getElementById('stat-orders').textContent = inquiries.filter(i => i.status === 'Auftrag').length;
        document.getElementById('stat-calcs').textContent = calcs.length;
        document.getElementById('stat-emails').textContent = emails.length;

        // ML status table
        const models = mlStatus.models || [];
        let html = '<table><thead><tr><th>Modell</th><th>Status</th></tr></thead><tbody>';
        models.forEach(m => {
            html += `<tr>
                <td>${m.model_key}</td>
                <td>${m.trained
                    ? '<span class="badge badge-success">âœ“ Trainiert</span>'
                    : '<span class="badge badge-secondary">Nicht trainiert</span>'
                }</td>
            </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('model-status-table').innerHTML = html;

        // Recent calcs
        const tbody = document.getElementById('recent-calcs-body');
        if (calcs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#718096">Keine Kalkulationen vorhanden</td></tr>';
        } else {
            tbody.innerHTML = calcs.slice(0, 5).map(c => `
                <tr>
                    <td><a href="/kalkulation.html">${c.calc_number}</a></td>
                    <td>${c.calc_name}</td>
                    <td>${c.machine}</td>
                    <td>${c.material_group === 'IN718_IN625' ? 'IN718/IN625' : c.material_group}</td>
                    <td>${formatEur(c.total_manual_price)}</td>
                    <td>${formatEur(c.total_calc_price)}</td>
                    <td class="${c.total_savings_eur > 0 ? 'savings-positive' : ''}">${formatEur(c.total_savings_eur)}</td>
                    <td><span class="badge badge-${c.status === 'open' ? 'info' : 'success'}">${c.status}</span></td>
                </tr>
            `).join('');
        }
    } catch(e) {
        showToast('Fehler beim Laden: ' + e.message, 'error');
    }
}

async function trainModels() {
    try {
        showToast('Modelle werden trainiert...', 'info');
        const result = await apiFetch('/api/ml/train', { method: 'POST' });
        result.results.forEach(r => {
            showToast(r.message, r.success ? 'success' : 'error');
        });
        loadDashboard();
    } catch(e) {
        showToast('Training fehlgeschlagen: ' + e.message, 'error');
    }
}

loadDashboard();
</script>
</body>
</html>
