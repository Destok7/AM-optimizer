<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>E-Mail-Entw√ºrfe ‚Äì LPBF Optimizer</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div class="app-layout">

    <nav class="sidebar">
        <div class="sidebar-logo"><h2>‚öôÔ∏è LPBF Optimizer</h2><p>Produktionsplanung</p></div>
        <div class="sidebar-nav">
            <a href="/static/dashboard.html"    class="nav-item"><span class="icon">üìä</span> Dashboard</a>
            <a href="/static/inquiry.html"       class="nav-item"><span class="icon">üìã</span> Anfragen</a>
            <a href="/static/buildjobs.html"     class="nav-item"><span class="icon">üèóÔ∏è</span> Build-Jobs</a>
            <a href="/static/nesting.html"       class="nav-item"><span class="icon">üî≤</span> Nesting</a>
            <a href="/static/notifications.html" class="nav-item active"><span class="icon">‚úâÔ∏è</span> E-Mail-Entw√ºrfe</a>
        </div>
        <div class="sidebar-footer">
            <span id="user-name"></span>
            <a href="#" onclick="logout()" style="color:rgba(255,255,255,0.4);font-size:12px;text-decoration:none;">Abmelden</a>
        </div>
    </nav>

    <div class="main-content">
        <div class="topbar">
            <h1>E-Mail-Entw√ºrfe</h1>
        </div>
        <div class="page-body">

            <div id="alert-area"></div>

            <!-- Generate Email Form -->
            <div class="card">
                <div class="card-title">‚úâÔ∏è E-Mail-Entwurf generieren (GPT-4)</div>
                <p style="color:var(--text-muted);margin-bottom:16px;font-size:14px">
                    GPT-4 erstellt einen professionellen deutschen E-Mail-Entwurf. Sie k√∂nnen ihn √ºberpr√ºfen,
                    kopieren und manuell aus Ihrem E-Mail-Programm versenden.
                </p>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Anfrage ausw√§hlen</label>
                        <select id="inquiry-select">
                            <option value="">‚Äì Anfrage w√§hlen ‚Äì</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Build-Job ausw√§hlen</label>
                        <select id="job-select">
                            <option value="">‚Äì Build-Job w√§hlen ‚Äì</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>E-Mail-Typ</label>
                        <select id="notif-type">
                            <option value="price_reduction_current">Aktueller Auftrag ‚Äì Preisreduktion</option>
                            <option value="price_reduction_returning">R√ºckkehrender Kunde ‚Äì Preisreduktion</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Urspr√ºnglicher St√ºckpreis [‚Ç¨]</label>
                        <input type="number" id="f-orig-price" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Neuer St√ºckpreis [‚Ç¨]</label>
                        <input type="number" id="f-new-price" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Preisersparnis [%]</label>
                        <input type="number" id="f-reduction" step="0.1" placeholder="0.0">
                    </div>
                    <div class="form-group">
                        <label>Urspr√ºngliche Bauzeit [h]</label>
                        <input type="number" id="f-orig-time" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Neue Bauzeit (kombiniert) [h]</label>
                        <input type="number" id="f-new-time" step="0.01" placeholder="0.00">
                    </div>
                </div>
                <div style="margin-top:20px">
                    <button class="btn btn-accent" onclick="generateEmail()">ü§ñ E-Mail generieren</button>
                </div>

                <div id="generated-email" style="display:none;margin-top:24px">
                    <h4 style="margin-bottom:8px">üìß Betreff:</h4>
                    <div id="email-subject" style="background:#f8fafc;border:1px solid var(--border);border-radius:6px;padding:10px 14px;font-weight:600;margin-bottom:12px"></div>
                    <h4 style="margin-bottom:8px">üìù E-Mail-Text:</h4>
                    <div id="email-body" class="email-preview"></div>
                    <div style="margin-top:12px;display:flex;gap:10px">
                        <button class="btn btn-outline" onclick="copyEmail()">üìã Text kopieren</button>
                        <button class="btn btn-success" onclick="markReviewed()">‚úÖ Als gepr√ºft markieren</button>
                    </div>
                </div>
            </div>

            <!-- Drafts List -->
            <div class="card">
                <div class="card-title">üì¨ Alle E-Mail-Entw√ºrfe</div>
                <div style="margin-bottom:12px">
                    <select id="filter-status" onchange="loadNotifications()" style="padding:7px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px">
                        <option value="">Alle</option>
                        <option value="draft">Entwurf</option>
                        <option value="reviewed">Gepr√ºft</option>
                        <option value="sent_manually">Manuell gesendet</option>
                    </select>
                </div>
                <div id="notifications-list"></div>
            </div>

        </div>
    </div>
</div>

<script src="/static/js/auth.js"></script>
<script>
    requireAuth();
    setUserName();

    let currentNotificationId = null;

    async function init() {
        // Load inquiries for select
        const inqRes = await apiFetch('/api/inquiries/');
        if (!inqRes) return;
        const inquiries = await inqRes.json();
        const inqSel = document.getElementById('inquiry-select');
        inquiries.forEach(i => {
            inqSel.innerHTML += `<option value="${i.inquiry_id}">${i.inquiry_name} (${i.customer_number})</option>`;
        });

        // Load jobs for select
        const jobRes = await apiFetch('/api/buildjobs/');
        if (!jobRes) return;
        const jobs = await jobRes.json();
        const jobSel = document.getElementById('job-select');
        jobs.forEach(j => {
            jobSel.innerHTML += `<option value="${j.job_id}">${j.job_name}</option>`;
        });

        loadNotifications();
    }

    async function generateEmail() {
        const inquiryId = document.getElementById('inquiry-select').value;
        const jobId = document.getElementById('job-select').value;

        if (!inquiryId || !jobId) {
            showAlert('alert-area', 'Bitte Anfrage und Build-Job ausw√§hlen.', 'error');
            return;
        }

        const body = {
            inquiry_id:             parseInt(inquiryId),
            job_id:                 parseInt(jobId),
            notification_type:      document.getElementById('notif-type').value,
            original_price:         parseFloat(document.getElementById('f-orig-price').value) || 0,
            new_price:              parseFloat(document.getElementById('f-new-price').value) || 0,
            price_reduction_percent:parseFloat(document.getElementById('f-reduction').value) || 0,
            original_build_time_h:  parseFloat(document.getElementById('f-orig-time').value) || 0,
            new_build_time_h:       parseFloat(document.getElementById('f-new-time').value) || 0,
        };

        showAlert('alert-area', '‚è≥ GPT-4 generiert E-Mail-Entwurf...', 'info');

        const res = await apiFetch('/api/notifications/generate', { method: 'POST', body: JSON.stringify(body) });
        if (!res) return;
        const data = await res.json();

        if (!res.ok) {
            showAlert('alert-area', data.detail || 'Fehler beim Generieren.', 'error');
            return;
        }

        currentNotificationId = data.notification_id;
        document.getElementById('email-subject').textContent = data.subject;
        document.getElementById('email-body').textContent = data.body;
        document.getElementById('generated-email').style.display = 'block';
        showAlert('alert-area', 'E-Mail-Entwurf erfolgreich generiert.', 'success');
        loadNotifications();
    }

    function copyEmail() {
        const subject = document.getElementById('email-subject').textContent;
        const body = document.getElementById('email-body').textContent;
        navigator.clipboard.writeText(`Betreff: ${subject}\n\n${body}`);
        showAlert('alert-area', 'E-Mail in Zwischenablage kopiert.', 'success');
    }

    async function markReviewed() {
        if (!currentNotificationId) return;
        await apiFetch(`/api/notifications/${currentNotificationId}/status?status=reviewed`, { method: 'PUT' });
        showAlert('alert-area', 'Als gepr√ºft markiert.', 'success');
        loadNotifications();
    }

    async function updateStatus(id, status) {
        await apiFetch(`/api/notifications/${id}/status?status=${status}`, { method: 'PUT' });
        loadNotifications();
    }

    async function loadNotifications() {
        const status = document.getElementById('filter-status').value;
        const url = `/api/notifications/${status ? '?status=' + status : ''}`;
        const res = await apiFetch(url);
        if (!res) return;
        const notifications = await res.json();
        const container = document.getElementById('notifications-list');

        if (notifications.length === 0) {
            container.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px">Keine Entw√ºrfe vorhanden</p>';
            return;
        }

        container.innerHTML = notifications.map(n => `
            <div style="border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
                    <div>
                        <strong>${n.email_subject}</strong>
                        <div style="font-size:13px;color:var(--text-muted);margin-top:2px">
                            Kundennr.: ${n.customer_number} | Anfragenr.: ${n.inquiry_number || '‚Äì'} |
                            Erstellt: ${new Date(n.generated_at).toLocaleString('de-DE')}
                        </div>
                    </div>
                    <div style="display:flex;gap:6px;align-items:center">
                        ${statusBadge(n.status)}
                        <button class="btn btn-sm btn-outline" onclick="togglePreview('preview-${n.notification_id}')">Vorschau</button>
                        ${n.status === 'draft' ? `<button class="btn btn-sm btn-success" onclick="updateStatus(${n.notification_id},'reviewed')">‚úÖ Gepr√ºft</button>` : ''}
                        ${n.status === 'reviewed' ? `<button class="btn btn-sm btn-primary" onclick="updateStatus(${n.notification_id},'sent_manually')">üì§ Gesendet</button>` : ''}
                    </div>
                </div>
                <div id="preview-${n.notification_id}" class="email-preview" style="display:none">${n.email_body}</div>
            </div>
        `).join('');
    }

    function togglePreview(id) {
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    init();
</script>
</body>
</html>
