<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Mail-Entw√ºrfe ‚Äì AM-Optimizer</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div class="app-layout">
    <div id="sidebar-container"></div>
    <div class="main-content">
        <div class="top-bar">
            <h1>E-Mail-Entw√ºrfe</h1>
            <button class="btn btn-primary btn-sm" onclick="openGenerateModal()">+ Neuen Entwurf erstellen</button>
        </div>
        <div class="page-body">
            <!-- Summary stats -->
            <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);">
                <div class="stat-card"><div class="stat-label">Alle Entw√ºrfe</div><div class="stat-value" id="stat-all">‚Äì</div></div>
                <div class="stat-card orange"><div class="stat-label">Entwurf</div><div class="stat-value" id="stat-draft">‚Äì</div></div>
                <div class="stat-card green"><div class="stat-label">Gepr√ºft</div><div class="stat-value" id="stat-reviewed">‚Äì</div></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">E-Mail-Entw√ºrfe</div>
                    <select class="form-control" id="filter-status" style="width:160px;" onchange="loadEmails()">
                        <option value="">Alle</option>
                        <option value="draft">Entwurf</option>
                        <option value="reviewed">Gepr√ºft</option>
                        <option value="sent_manually">Manuell gesendet</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kalk.-Nr.</th>
                                <th>Anfragenr.</th>
                                <th>Auftragsnr.</th>
                                <th>Kundennr.</th>
                                <th>Betreff</th>
                                <th>Status</th>
                                <th>Erstellt</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="emails-body">
                            <tr><td colspan="9" style="text-align:center;padding:24px;color:#718096">Lade...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Email Modal -->
<div class="modal-overlay" id="generate-modal">
    <div class="modal" style="max-width:640px;">
        <div class="modal-header">
            <div class="modal-title">Neuen E-Mail-Entwurf erstellen</div>
            <button class="modal-close" onclick="closeModal('generate-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="gen-alert"></div>
            <div class="form-group">
                <label class="form-label">Kalkulation *</label>
                <select class="form-control" id="gen-calc" onchange="loadCalcInquiries()">
                    <option value="">-- Kalkulation w√§hlen --</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Typ</label>
                <select class="form-control" id="gen-type" onchange="toggleOrderInput()">
                    <option value="Anfrage">Anfrage</option>
                    <option value="Auftrag">Auftrag</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Anfragenummer *</label>
                <select class="form-control" id="gen-inquiry">
                    <option value="">-- erst Kalkulation w√§hlen --</option>
                </select>
            </div>
            <div class="form-group" id="order-input-group" style="display:none;">
                <label class="form-label">Auftragsnummer</label>
                <input class="form-control" id="gen-order" placeholder="z.B. ATN20260001">
            </div>

            <!-- Comparison preview -->
            <div id="calc-preview" style="display:none;">
                <div style="font-weight:600;font-size:13px;margin-bottom:8px;">Vorschau der Vergleichsdaten</div>
                <div class="table-container">
                    <table id="preview-table" style="font-size:12px;">
                        <thead><tr>
                            <th>Bauteil</th><th>Orig. Preis</th><th>Kalk. Preis</th><th>Ersparnis ‚Ç¨</th><th>Ersparnis %</th>
                        </tr></thead>
                        <tbody id="preview-body"></tbody>
                        <tfoot id="preview-foot" style="font-weight:600;background:#f0f4f8;"></tfoot>
                    </table>
                </div>
                <div style="margin-top:8px;font-size:12px;color:#718096;" id="buildtime-comparison"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal('generate-modal')">Abbrechen</button>
            <button class="btn btn-primary" onclick="generateDraft()" id="gen-btn">ü§ñ Mit GPT-4 generieren</button>
        </div>
    </div>
</div>

<!-- Email Detail/Edit Modal -->
<div class="modal-overlay" id="email-modal">
    <div class="modal" style="max-width:700px;">
        <div class="modal-header">
            <div class="modal-title">E-Mail-Entwurf</div>
            <button class="modal-close" onclick="closeModal('email-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Betreff</label>
                <input class="form-control" id="edit-subject">
            </div>
            <div class="form-group">
                <label class="form-label">Inhalt</label>
                <textarea class="form-control" id="edit-body" rows="16" style="font-family:inherit;"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-control" id="edit-status">
                    <option value="draft">Entwurf</option>
                    <option value="reviewed">Gepr√ºft</option>
                    <option value="sent_manually">Manuell gesendet</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal('email-modal')">Abbrechen</button>
            <button class="btn btn-primary" onclick="saveEmail()">Speichern</button>
        </div>
    </div>
</div>

<script src="/static/js/auth.js"></script>
<script src="/static/js/app.js"></script>
<script>
checkAuth();
document.getElementById('sidebar-container').innerHTML = renderSidebar('emails');

let allEmails = [];
let editingEmailId = null;
let allCalcs = [];
let currentCalcData = null;

// Check if opened from kalkulation page with calc_id
const urlParams = new URLSearchParams(window.location.search);
const preselectedCalcId = urlParams.get('calc_id');

async function loadEmails() {
    const status = document.getElementById('filter-status').value;
    let url = '/api/emails/';
    if (status) url += `?status=${status}`;
    try {
        allEmails = await apiFetch(url);
        document.getElementById('stat-all').textContent = allEmails.length;
        document.getElementById('stat-draft').textContent = allEmails.filter(e => e.status === 'draft').length;
        document.getElementById('stat-reviewed').textContent = allEmails.filter(e => e.status === 'reviewed').length;
        renderEmails();
    } catch(e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

function renderEmails() {
    const tbody = document.getElementById('emails-body');
    if (allEmails.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:24px;color:#718096">Keine E-Mail-Entw√ºrfe vorhanden</td></tr>';
        return;
    }
    tbody.innerHTML = allEmails.map(e => `
        <tr>
            <td>${e.notification_id}</td>
            <td>${e.calc_id || '‚Äî'}</td>
            <td>${e.inquiry_number}</td>
            <td>${e.order_number || '‚Äî'}</td>
            <td>${e.customer_number}</td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${e.email_subject}</td>
            <td><span class="badge badge-${e.status === 'reviewed' ? 'success' : e.status === 'sent_manually' ? 'secondary' : 'warning'}">${statusLabel(e.status)}</span></td>
            <td style="font-size:12px;">${new Date(e.generated_at).toLocaleDateString('de-DE')}</td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-icon btn-outline btn-sm" onclick="openEmailEdit(${e.notification_id})" title="Bearbeiten">‚úèÔ∏è</button>
                    <button class="btn btn-icon btn-danger btn-sm" onclick="deleteEmail(${e.notification_id})" title="L√∂schen">üóëÔ∏è</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function statusLabel(s) {
    if (s === 'draft') return 'Entwurf';
    if (s === 'reviewed') return 'Gepr√ºft';
    if (s === 'sent_manually') return 'Gesendet';
    return s;
}

async function openGenerateModal() {
    document.getElementById('gen-alert').innerHTML = '';
    document.getElementById('calc-preview').style.display = 'none';

    // Load calcs
    allCalcs = await apiFetch('/api/kalkulation/');
    const sel = document.getElementById('gen-calc');
    sel.innerHTML = '<option value="">-- Kalkulation w√§hlen --</option>';
    allCalcs.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.calc_id;
        opt.textContent = `${c.calc_number} ‚Äì ${c.calc_name}`;
        if (preselectedCalcId && c.calc_id == preselectedCalcId) opt.selected = true;
        sel.appendChild(opt);
    });

    document.getElementById('generate-modal').classList.add('active');

    if (preselectedCalcId) loadCalcInquiries();
}

async function loadCalcInquiries() {
    const calcId = document.getElementById('gen-calc').value;
    if (!calcId) return;

    currentCalcData = await apiFetch(`/api/kalkulation/${calcId}`);

    // Populate inquiry select (unique inquiry numbers from parts)
    const inquiries = [...new Map(currentCalcData.parts.map(p => [p.inquiry_number, p])).values()];
    const sel = document.getElementById('gen-inquiry');
    sel.innerHTML = '<option value="">-- Anfrage w√§hlen --</option>';
    inquiries.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.inquiry_number;
        opt.textContent = p.inquiry_number + (p.order_number ? ` / ${p.order_number}` : '');
        sel.appendChild(opt);
    });

    sel.onchange = updatePreview;
}

function updatePreview() {
    const inquiryNum = document.getElementById('gen-inquiry').value;
    if (!inquiryNum || !currentCalcData) return;

    const parts = currentCalcData.parts.filter(p => p.inquiry_number === inquiryNum);
    if (parts.length === 0) return;

    document.getElementById('calc-preview').style.display = 'block';

    let totalManual = 0, totalCalc = 0, totalSavings = 0;
    const tbody = document.getElementById('preview-body');
    tbody.innerHTML = parts.map(p => {
        totalManual += (p.manual_part_price_eur || 0) * p.quantity;
        totalCalc += (p.calc_part_price_eur || 0) * p.quantity;
        totalSavings += (p.price_reduction_eur || 0) * p.quantity;
        return `<tr>
            <td>${p.part_name} (√ó${p.quantity})</td>
            <td>${formatEur(p.manual_part_price_eur)}</td>
            <td>${p.calc_part_price_eur != null ? formatEur(p.calc_part_price_eur) : '‚Äî'}</td>
            <td class="${p.price_reduction_eur > 0 ? 'savings-positive' : ''}">${p.price_reduction_eur != null ? formatEur(p.price_reduction_eur) : '‚Äî'}</td>
            <td class="${p.price_reduction_percent > 0 ? 'savings-positive' : ''}">${p.price_reduction_percent != null ? p.price_reduction_percent + '%' : '‚Äî'}</td>
        </tr>`;
    }).join('');

    const savingsPct = totalManual > 0 ? ((totalSavings / totalManual) * 100).toFixed(1) : 0;
    document.getElementById('preview-foot').innerHTML = `
        <tr>
            <td>Gesamt</td>
            <td>${formatEur(totalManual)}</td>
            <td>${formatEur(totalCalc)}</td>
            <td class="savings-positive">${formatEur(totalSavings)}</td>
            <td class="savings-positive">${savingsPct}%</td>
        </tr>`;

    document.getElementById('buildtime-comparison').textContent =
        `Kombinierte Bauzeit: ${formatNum(currentCalcData.combined_build_time_h, 1)} h`;
}

function toggleOrderInput() {
    const isOrder = document.getElementById('gen-type').value === 'Auftrag';
    document.getElementById('order-input-group').style.display = isOrder ? 'block' : 'none';
}

async function generateDraft() {
    const alertEl = document.getElementById('gen-alert');
    const calcId = parseInt(document.getElementById('gen-calc').value);
    const inquiryNum = document.getElementById('gen-inquiry').value;
    const orderNum = document.getElementById('gen-order').value.trim() || null;

    if (!calcId || !inquiryNum) {
        alertEl.innerHTML = '<div class="alert alert-danger">Bitte Kalkulation und Anfragenummer w√§hlen.</div>';
        return;
    }

    const btn = document.getElementById('gen-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Generiere...';
    alertEl.innerHTML = '<div class="alert alert-info">GPT-4 erstellt den Entwurf...</div>';

    try {
        await apiFetch('/api/emails/generate', {
            method: 'POST',
            body: JSON.stringify({ calc_id: calcId, inquiry_number: inquiryNum, order_number: orderNum })
        });
        showToast('E-Mail-Entwurf erstellt', 'success');
        closeModal('generate-modal');
        loadEmails();
    } catch(e) {
        alertEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'ü§ñ Mit GPT-4 generieren';
    }
}

function openEmailEdit(id) {
    const email = allEmails.find(e => e.notification_id === id);
    if (!email) return;
    editingEmailId = id;
    document.getElementById('edit-subject').value = email.email_subject;
    document.getElementById('edit-body').value = email.email_body;
    document.getElementById('edit-status').value = email.status;
    document.getElementById('email-modal').classList.add('active');
}

async function saveEmail() {
    try {
        await apiFetch(`/api/emails/${editingEmailId}`, {
            method: 'PUT',
            body: JSON.stringify({
                email_subject: document.getElementById('edit-subject').value,
                email_body:    document.getElementById('edit-body').value,
                status:        document.getElementById('edit-status').value,
            })
        });
        showToast('Gespeichert', 'success');
        closeModal('email-modal');
        loadEmails();
    } catch(e) { showToast(e.message, 'error'); }
}

async function deleteEmail(id) {
    if (!confirm('E-Mail-Entwurf l√∂schen?')) return;
    try {
        await apiFetch(`/api/emails/${id}`, { method: 'DELETE' });
        showToast('Gel√∂scht', 'success');
        loadEmails();
    } catch(e) { showToast(e.message, 'error'); }
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

loadEmails();

// Auto-open generate modal if coming from kalkulation page
if (preselectedCalcId) {
    openGenerateModal();
}
</script>
</body>
</html>
