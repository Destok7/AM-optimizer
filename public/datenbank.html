<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datenbank ‚Äì AM-Optimizer</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div class="app-layout">
    <div id="sidebar-container"></div>
    <div class="main-content">
        <div class="top-bar">
            <h1>Datenbank</h1>
            <div style="display:flex;gap:8px;">
                <button class="btn btn-outline btn-sm" onclick="openImportModal()">üì• Importieren</button>
                <button class="btn btn-primary btn-sm" onclick="openNewModal()">+ Neue Anfrage</button>
            </div>
        </div>
        <div class="page-body">
            <!-- Filters -->
            <div class="card" style="padding:12px 16px;margin-bottom:16px;">
                <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
                    <select class="form-control" id="filter-status" style="width:140px;" onchange="loadData()">
                        <option value="">Alle Status</option>
                        <option value="Anfrage">Anfrage</option>
                        <option value="Auftrag">Auftrag</option>
                    </select>
                    <select class="form-control" id="filter-machine" style="width:140px;" onchange="loadData()">
                        <option value="">Alle Maschinen</option>
                        <option>Xline</option><option>EOS</option>
                        <option>M2_alt</option><option>M2_neu</option>
                    </select>
                    <select class="form-control" id="filter-sort" style="width:180px;" onchange="loadData()">
                        <option value="inquiry_number">Sort: Anfragenummer</option>
                        <option value="order_number">Sort: Auftragsnummer</option>
                    </select>
                    <input class="form-control" id="filter-search" placeholder="Suche..." style="width:200px;" oninput="filterTable()">
                </div>
            </div>

            <!-- Table -->
            <div class="card">
                <div class="table-container">
                    <table id="main-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Anfragenr.</th>
                                <th>Auftragsnr.</th>
                                <th>Kundennr.</th>
                                <th>Maschine</th>
                                <th>Status</th>
                                <th>Liefertermin</th>
                                <th>Plattform %</th>
                                <th>Teile</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <tr><td colspan="10" style="text-align:center;padding:24px;color:#718096">Lade Daten...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New/Edit Inquiry Modal -->
<div class="modal-overlay" id="inquiry-modal">
    <div class="modal" style="max-width:900px;">
        <div class="modal-header">
            <div class="modal-title" id="modal-title">Neue Anfrage</div>
            <button class="modal-close" onclick="closeModal('inquiry-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="modal-alert"></div>
            <div class="form-row-3">
                <div class="form-group">
                    <label class="form-label">Anfragenummer *</label>
                    <input class="form-control" id="f-inquiry-number" placeholder="z.B. AFN20260001">
                </div>
                <div class="form-group">
                    <label class="form-label">Auftragsnummer</label>
                    <input class="form-control" id="f-order-number" placeholder="z.B. ATN20260001">
                </div>
                <div class="form-group">
                    <label class="form-label">Kundennummer *</label>
                    <input class="form-control" id="f-customer-number" placeholder="z.B. KN0001">
                </div>
            </div>
            <div class="form-row-3">
                <div class="form-group">
                    <label class="form-label">Maschine *</label>
                    <select class="form-control" id="f-machine" onchange="onMachineChange()">
                        <option value="">-- w√§hlen --</option>
                        <option>Xline</option><option>EOS</option>
                        <option>M2_alt</option><option>M2_neu</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-control" id="f-status" onchange="toggleOrderDate()">
                        <option value="Anfrage">Anfrage</option>
                        <option value="Auftrag">Auftrag</option>
                    </select>
                </div>
                <div class="form-group" id="order-date-group" style="display:none;">
                    <label class="form-label">Auftragsdatum</label>
                    <input class="form-control" type="date" id="f-order-date">
                </div>
            </div>
            <div class="form-row-2">
                <div class="form-group">
                    <label class="form-label">Anfragedatum</label>
                    <input class="form-control" type="date" id="f-inquiry-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Liefertermin</label>
                    <input class="form-control" type="date" id="f-delivery-date">
                </div>
            </div>

            <!-- Parts section -->
            <div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0 8px;">
                <strong style="font-size:14px;">Bauteile</strong>
                <button class="btn btn-outline btn-sm" onclick="addPartRow()">+ Bauteil hinzuf√ºgen</button>
            </div>
            <div id="parts-container"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal('inquiry-modal')">Abbrechen</button>
            <button class="btn btn-primary" onclick="saveInquiry()" id="save-btn">Speichern</button>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal-overlay" id="import-modal">
    <div class="modal" style="max-width:560px;">
        <div class="modal-header">
            <div class="modal-title">Daten importieren</div>
            <button class="modal-close" onclick="closeModal('import-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="import-alert"></div>
            <div class="dropzone" id="dropzone" onclick="document.getElementById('file-input').click()"
                 ondragover="event.preventDefault();this.classList.add('dragover')"
                 ondragleave="this.classList.remove('dragover')"
                 ondrop="handleDrop(event)">
                <div class="drop-icon">üìÇ</div>
                <p><strong>Excel (.xlsx) oder TXT/CSV</strong> hierher ziehen</p>
                <p style="margin-top:4px;">oder klicken zum Ausw√§hlen</p>
                <input type="file" id="file-input" accept=".xlsx,.xls,.txt,.csv" style="display:none" onchange="handleFileSelect(event)">
            </div>
            <div style="margin-top:12px;font-size:12px;color:#718096;">
                <strong>Erforderliche Spalten:</strong> anfragenummer, kundennummer, maschine, material, bauteilname<br>
                <strong>Optional:</strong> auftragsnummer, anzahl, bauteilvolumen_mm3, stuetzstruktur_cm3, bauhoehe_mm, vorbereitung_min, nachbearbeitung_min, strahlen_min, dichtheitspruefung_min, qualitaetskontrolle_min, xy_flaeche_mm2, stueckpreis_eur, bauzeit_h
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal('import-modal')">Schlie√üen</button>
        </div>
    </div>
</div>

<script src="/static/js/auth.js"></script>
<script src="/static/js/app.js"></script>
<script>
checkAuth();
document.getElementById('sidebar-container').innerHTML = renderSidebar('datenbank');

let allData = [];
let editingId = null;
let partCounter = 0;

async function loadData() {
    const status = document.getElementById('filter-status').value;
    const machine = document.getElementById('filter-machine').value;
    const sort = document.getElementById('filter-sort').value;

    let url = `/api/datenbank/?sort_by=${sort}`;
    if (status) url += `&status=${status}`;
    if (machine) url += `&machine=${machine}`;

    try {
        allData = await apiFetch(url);
        renderTable(allData);
    } catch(e) {
        showToast('Ladefehler: ' + e.message, 'error');
    }
}

function filterTable() {
    const q = document.getElementById('filter-search').value.toLowerCase();
    const filtered = allData.filter(inq =>
        inq.inquiry_number.toLowerCase().includes(q) ||
        (inq.order_number || '').toLowerCase().includes(q) ||
        inq.customer_number.toLowerCase().includes(q)
    );
    renderTable(filtered);
}

function renderTable(data) {
    const tbody = document.getElementById('table-body');
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:24px;color:#718096">Keine Daten vorhanden</td></tr>';
        return;
    }
    tbody.innerHTML = data.map(inq => {
        const pct = inq.platform_occupation_pct || 0;
        const barClass = pct >= 90 ? 'danger' : pct >= 70 ? 'warn' : '';
        return `
        <tr>
            <td><button class="btn btn-icon btn-outline btn-sm" onclick="toggleParts(${inq.inquiry_id})">‚ñº</button></td>
            <td><strong>${inq.inquiry_number}</strong></td>
            <td>${inq.order_number || '<span style="color:#ccc">‚Äî</span>'}</td>
            <td>${inq.customer_number}</td>
            <td><span class="badge badge-secondary">${inq.machine}</span></td>
            <td><span class="badge badge-${inq.status === 'Auftrag' ? 'success' : 'info'}">${inq.status}</span></td>
            <td>${inq.requested_delivery_date || '‚Äî'}</td>
            <td>
                <div class="platform-bar-wrap">
                    <div class="platform-bar-label"><span>${pct}%</span></div>
                    <div class="platform-bar-bg"><div class="platform-bar-fill ${barClass}" style="width:${Math.min(pct,100)}%"></div></div>
                </div>
            </td>
            <td>${inq.parts.length}</td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-icon btn-outline btn-sm" onclick="editInquiry(${inq.inquiry_id})" title="Bearbeiten">‚úèÔ∏è</button>
                    <button class="btn btn-icon btn-danger btn-sm" onclick="deleteInquiry(${inq.inquiry_id})" title="L√∂schen">üóëÔ∏è</button>
                </div>
            </td>
        </tr>
        <tr id="parts-row-${inq.inquiry_id}" style="display:none;">
            <td colspan="10" style="padding:0;">
                <div style="padding:8px 16px;background:#f8fafc;">
                    <table style="width:100%;font-size:12px;">
                        <thead><tr style="background:#edf2f7;">
                            <th style="padding:6px 8px;">Bauteilname</th>
                            <th>Material</th>
                            <th>Anzahl</th>
                            <th>Vol. [mm¬≥]</th>
                            <th>St√ºtzstr. [cm¬≥]</th>
                            <th>H√∂he [mm]</th>
                            <th>Vorb. [min]</th>
                            <th>Nachb. [min]</th>
                            <th>Strahlen [min]</th>
                            <th>Dicht. [min]</th>
                            <th>QK [min]</th>
                            <th>XY [mm¬≤]</th>
                            <th>Preis [‚Ç¨]</th>
                            <th>Bauzeit [h]</th>
                            <th>Aktion</th>
                        </tr></thead>
                        <tbody>
                        ${inq.parts.map(p => `
                            <tr>
                                <td>${p.part_name}</td>
                                <td>${p.material}</td>
                                <td>${p.quantity}</td>
                                <td>${p.part_volume_mm3 != null ? formatNum(p.part_volume_mm3, 0) : '‚Äî'}</td>
                                <td>${p.support_volume_cm3 != null ? formatNum(p.support_volume_cm3, 2) : '‚Äî'}</td>
                                <td>${p.part_height_mm != null ? formatNum(p.part_height_mm, 1) : '‚Äî'}</td>
                                <td>${p.prep_time_min != null ? formatNum(p.prep_time_min, 0) : '‚Äî'}</td>
                                <td>${p.post_handling_time_min != null ? formatNum(p.post_handling_time_min, 0) : '‚Äî'}</td>
                                <td>${p.blasting_time_min != null ? formatNum(p.blasting_time_min, 0) : '‚Äî'}</td>
                                <td>${p.leak_testing_time_min != null ? formatNum(p.leak_testing_time_min, 0) : '‚Äî'}</td>
                                <td>${p.qc_time_min != null ? formatNum(p.qc_time_min, 0) : '‚Äî'}</td>
                                <td>${p.projected_xy_surface_mm2 != null ? formatNum(p.projected_xy_surface_mm2, 0) : '‚Äî'}</td>
                                <td>${p.manual_part_price_eur != null ? formatEur(p.manual_part_price_eur) : '‚Äî'}</td>
                                <td>${p.manual_build_time_h != null ? formatNum(p.manual_build_time_h, 2) : '‚Äî'}</td>
                                <td><button class="btn btn-danger btn-sm btn-icon" onclick="deletePart(${p.part_id})">üóëÔ∏è</button></td>
                            </tr>
                        `).join('')}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function toggleParts(id) {
    const row = document.getElementById(`parts-row-${id}`);
    row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
}

function openNewModal() {
    editingId = null;
    document.getElementById('modal-title').textContent = 'Neue Anfrage';
    document.getElementById('f-inquiry-number').value = '';
    document.getElementById('f-order-number').value = '';
    document.getElementById('f-customer-number').value = '';
    document.getElementById('f-machine').value = '';
    document.getElementById('f-status').value = 'Anfrage';
    document.getElementById('f-inquiry-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('f-order-date').value = '';
    document.getElementById('f-delivery-date').value = '';
    document.getElementById('parts-container').innerHTML = '';
    document.getElementById('modal-alert').innerHTML = '';
    partCounter = 0;
    toggleOrderDate();
    addPartRow();
    document.getElementById('inquiry-modal').classList.add('active');
}

function editInquiry(id) {
    const inq = allData.find(i => i.inquiry_id === id);
    if (!inq) return;
    editingId = id;
    document.getElementById('modal-title').textContent = 'Anfrage bearbeiten';
    document.getElementById('f-inquiry-number').value = inq.inquiry_number;
    document.getElementById('f-order-number').value = inq.order_number || '';
    document.getElementById('f-customer-number').value = inq.customer_number;
    document.getElementById('f-machine').value = inq.machine;
    document.getElementById('f-status').value = inq.status;
    document.getElementById('f-inquiry-date').value = inq.inquiry_date || '';
    document.getElementById('f-order-date').value = inq.order_date || '';
    document.getElementById('f-delivery-date').value = inq.requested_delivery_date || '';
    document.getElementById('parts-container').innerHTML = '';
    document.getElementById('modal-alert').innerHTML = '';
    partCounter = 0;
    toggleOrderDate();
    onMachineChange();
    inq.parts.forEach(p => addPartRow(p));
    document.getElementById('inquiry-modal').classList.add('active');
}

function toggleOrderDate() {
    const isOrder = document.getElementById('f-status').value === 'Auftrag';
    document.getElementById('order-date-group').style.display = isOrder ? 'block' : 'none';
}

function onMachineChange() {
    const machine = document.getElementById('f-machine').value;
    document.querySelectorAll('.part-material-select').forEach(sel => {
        const current = sel.value;
        populateMaterialSelect(sel, machine);
        if (current && (MACHINE_MATERIALS[machine] || []).includes(current)) {
            sel.value = current;
        }
    });
}

function addPartRow(data = null) {
    const idx = partCounter++;
    const machine = document.getElementById('f-machine').value;
    const container = document.getElementById('parts-container');

    const div = document.createElement('div');
    div.className = 'card';
    div.style.cssText = 'padding:12px;margin-bottom:8px;border:1px solid #e2e8f0;box-shadow:none;';
    div.id = `part-row-${idx}`;

    let matOptions = '<option value="">-- w√§hlen --</option>';
    (MACHINE_MATERIALS[machine] || []).forEach(m => {
        matOptions += `<option value="${m}" ${data && data.material === m ? 'selected' : ''}>${m}</option>`;
    });

    div.innerHTML = `
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <strong style="font-size:13px;">Bauteil ${idx + 1}</strong>
            <button class="btn btn-danger btn-sm btn-icon" onclick="document.getElementById('part-row-${idx}').remove()">‚úï</button>
        </div>
        <div class="form-row-3">
            <div class="form-group">
                <label class="form-label">Bauteilname *</label>
                <input class="form-control part-name" value="${data ? data.part_name : ''}">
            </div>
            <div class="form-group">
                <label class="form-label">Material *</label>
                <select class="form-control part-material-select">${matOptions}</select>
            </div>
            <div class="form-group">
                <label class="form-label">Anzahl *</label>
                <input class="form-control part-quantity" type="number" min="1" value="${data ? data.quantity : 1}">
            </div>
        </div>
        <div class="form-row-3">
            <div class="form-group">
                <label class="form-label">Bauteilvolumen [mm¬≥] *</label>
                <input class="form-control part-volume" type="number" step="0.01" value="${data ? (data.part_volume_mm3 || '') : ''}">
            </div>
            <div class="form-group">
                <label class="form-label">St√ºtzstruktur [cm¬≥] *</label>
                <input class="form-control part-support" type="number" step="0.01" value="${data ? (data.support_volume_cm3 || '') : ''}">
            </div>
            <div class="form-group">
                <label class="form-label">Bauh√∂he [mm] *</label>
                <input class="form-control part-height" type="number" step="0.01" value="${data ? (data.part_height_mm || '') : ''}">
            </div>
        </div>
        <div class="form-row-3">
            <div class="form-group">
                <label class="form-label">Materialeinsatz [cm¬≥]</label>
                <input class="form-control part-stock" type="number" step="0.01" value="${data ? (data.stock_cm3 || '') : ''}">
            </div>
            <div class="form-group">
                <label class="form-label">XY-Fl√§che [mm¬≤]</label>
                <input class="form-control part-xy" type="number" step="0.01" value="${data ? (data.projected_xy_surface_mm2 || '') : ''}">
            </div>
            <div class="form-group">
                <label class="form-label">Vorbereitung [min]</label>
                <input class="form-control part-prep" type="number" step="0.1" value="${data ? (data.prep_time_min || '') : ''}">
            </div>
        </div>
        <div class="form-row-3">
            <div class="form-group">
                <label class="form-label">Nachbearbeitung [min]</label>
                <input class="form-control part-post" type="number" step="0.1" value="${data ? (data.post_handling_time_min || '') : ''}">
            </div>
            <div class="form-group">
                <label class="form-label">Strahlen [min]</label>
                <input class="form-control part-blast" type="number" step="0.1" value="${data ? (data.blasting_time_min || '') : ''}">
            </div>
            <div class="form-group">
                <label class="form-label">Dichtheitspr√ºfung [min]</label>
                <input class="form-control part-leak" type="number" step="0.1" value="${data ? (data.leak_testing_time_min || '') : ''}">
            </div>
        </div>
        <div class="form-row-3">
            <div class="form-group">
                <label class="form-label">Qualit√§tskontrolle [min]</label>
                <input class="form-control part-qc" type="number" step="0.1" value="${data ? (data.qc_time_min || '') : ''}">
            </div>
            <div class="form-group">
                <label class="form-label">St√ºckpreis [‚Ç¨] (manuell)</label>
                <input class="form-control part-price" type="number" step="0.01" value="${data ? (data.manual_part_price_eur || '') : ''}">
            </div>
            <div class="form-group">
                <label class="form-label">Bauzeit [h] (manuell)</label>
                <input class="form-control part-buildtime" type="number" step="0.01" value="${data ? (data.manual_build_time_h || '') : ''}">
            </div>
        </div>
    `;
    container.appendChild(div);
}

function getPartsFromForm() {
    const parts = [];
    document.querySelectorAll('#parts-container > div').forEach(row => {
        parts.push({
            part_name:               row.querySelector('.part-name').value.trim(),
            material:                row.querySelector('.part-material-select').value,
            quantity:                parseInt(row.querySelector('.part-quantity').value) || 1,
            part_volume_mm3:         parseFloat(row.querySelector('.part-volume').value) || 0,
            support_volume_cm3:      parseFloat(row.querySelector('.part-support').value) || 0,
            part_height_mm:          parseFloat(row.querySelector('.part-height').value) || 0,
            stock_cm3:               parseFloat(row.querySelector('.part-stock').value) || null,
            projected_xy_surface_mm2:parseFloat(row.querySelector('.part-xy').value) || null,
            prep_time_min:           parseFloat(row.querySelector('.part-prep').value) || null,
            post_handling_time_min:  parseFloat(row.querySelector('.part-post').value) || null,
            blasting_time_min:       parseFloat(row.querySelector('.part-blast').value) || null,
            leak_testing_time_min:   parseFloat(row.querySelector('.part-leak').value) || null,
            qc_time_min:             parseFloat(row.querySelector('.part-qc').value) || null,
            manual_part_price_eur:   parseFloat(row.querySelector('.part-price').value) || null,
            manual_build_time_h:     parseFloat(row.querySelector('.part-buildtime').value) || null,
        });
    });
    return parts;
}

async function saveInquiry() {
    const alertEl = document.getElementById('modal-alert');
    alertEl.innerHTML = '';

    const payload = {
        inquiry_number:          document.getElementById('f-inquiry-number').value.trim(),
        order_number:            document.getElementById('f-order-number').value.trim() || null,
        customer_number:         document.getElementById('f-customer-number').value.trim(),
        machine:                 document.getElementById('f-machine').value,
        status:                  document.getElementById('f-status').value,
        inquiry_date:            document.getElementById('f-inquiry-date').value || null,
        order_date:              document.getElementById('f-order-date').value || null,
        requested_delivery_date: document.getElementById('f-delivery-date').value || null,
        parts:                   getPartsFromForm(),
    };

    if (!payload.inquiry_number || !payload.customer_number || !payload.machine) {
        alertEl.innerHTML = '<div class="alert alert-danger">Bitte alle Pflichtfelder ausf√ºllen.</div>';
        return;
    }

    try {
        if (editingId) {
            await apiFetch(`/api/datenbank/${editingId}`, {
                method: 'PUT',
                body: JSON.stringify({ order_number: payload.order_number, order_date: payload.order_date, requested_delivery_date: payload.requested_delivery_date, status: payload.status, machine: payload.machine })
            });
        } else {
            await apiFetch('/api/datenbank/', { method: 'POST', body: JSON.stringify(payload) });
        }
        showToast('Gespeichert', 'success');
        closeModal('inquiry-modal');
        loadData();
    } catch(e) {
        alertEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
    }
}

async function deleteInquiry(id) {
    if (!confirm('Anfrage und alle Bauteile l√∂schen?')) return;
    try {
        await apiFetch(`/api/datenbank/${id}`, { method: 'DELETE' });
        showToast('Gel√∂scht', 'success');
        loadData();
    } catch(e) {
        showToast(e.message, 'error');
    }
}

async function deletePart(partId) {
    if (!confirm('Bauteil l√∂schen?')) return;
    try {
        await apiFetch(`/api/datenbank/parts/${partId}`, { method: 'DELETE' });
        showToast('Bauteil gel√∂scht', 'success');
        loadData();
    } catch(e) {
        showToast(e.message, 'error');
    }
}

function openImportModal() {
    document.getElementById('import-alert').innerHTML = '';
    document.getElementById('import-modal').classList.add('active');
}

function handleDrop(event) {
    event.preventDefault();
    document.getElementById('dropzone').classList.remove('dragover');
    const file = event.dataTransfer.files[0];
    if (file) uploadFile(file);
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) uploadFile(file);
}

async function uploadFile(file) {
    const alertEl = document.getElementById('import-alert');
    alertEl.innerHTML = '<div class="alert alert-info">Datei wird importiert...</div>';
    const formData = new FormData();
    formData.append('file', file);
    try {
        const res = await fetch('/api/datenbank/import', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${getToken()}` },
            body: formData,
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Fehler');
        let html = `<div class="alert alert-success">${data.message}</div>`;
        if (data.errors && data.errors.length > 0) {
            html += `<div class="alert alert-warning">Warnungen:<br>${data.errors.join('<br>')}</div>`;
        }
        alertEl.innerHTML = html;
        loadData();
    } catch(e) {
        alertEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
    }
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

loadData();
</script>
</body>
</html>
