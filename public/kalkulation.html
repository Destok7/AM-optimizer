<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kombinierte Kalkulation ‚Äì AM-Optimizer</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div class="app-layout">
    <div id="sidebar-container"></div>
    <div class="main-content">
        <div class="top-bar">
            <h1>Kombinierte Kalkulation</h1>
            <button class="btn btn-primary btn-sm" onclick="openNewCalcModal()">+ Neue Kalkulation</button>
        </div>
        <div class="page-body">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Alle Kalkulationen</div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Kalk.-Nr.</th>
                                <th>Name</th>
                                <th>Maschine</th>
                                <th>Material</th>
                                <th>Plattform %</th>
                                <th>Orig. Preis</th>
                                <th>Kalk. Preis</th>
                                <th>Ersparnis</th>
                                <th>Bauzeit [h]</th>
                                <th>Deadline</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="calcs-body">
                            <tr><td colspan="12" style="text-align:center;padding:24px;color:#718096">Lade...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Calculation Modal -->
<div class="modal-overlay" id="new-calc-modal">
    <div class="modal" style="max-width:560px;">
        <div class="modal-header">
            <div class="modal-title">Neue Kalkulation</div>
            <button class="modal-close" onclick="closeModal('new-calc-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="new-calc-alert"></div>
            <div class="form-group">
                <label class="form-label">Kalkulationsname *</label>
                <input class="form-control" id="nc-name" placeholder="z.B. Job-2026-Q1-M2">
            </div>
            <div class="form-row-2">
                <div class="form-group">
                    <label class="form-label">Maschine *</label>
                    <select class="form-control" id="nc-machine" onchange="onNewCalcMachineChange()">
                        <option value="">-- w√§hlen --</option>
                        <option>Xline</option><option>EOS</option>
                        <option>M2_alt</option><option>M2_neu</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Materialgruppe *</label>
                    <select class="form-control" id="nc-material">
                        <option value="">-- erst Maschine w√§hlen --</option>
                    </select>
                </div>
            </div>
            <div class="form-group" id="nc-platform-display" style="display:none;">
                <label class="form-label">Plattformfl√§che</label>
                <input class="form-control" id="nc-platform" disabled>
            </div>
            <div class="form-row-2">
                <div class="form-group">
                    <label class="form-label">Startdatum</label>
                    <input class="form-control" type="date" id="nc-start">
                </div>
                <div class="form-group">
                    <label class="form-label">Fertigungsdeadline</label>
                    <input class="form-control" type="date" id="nc-end">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal('new-calc-modal')">Abbrechen</button>
            <button class="btn btn-primary" onclick="createCalc()">Erstellen</button>
        </div>
    </div>
</div>

<!-- Detail / Edit Calculation Modal -->
<div class="modal-overlay" id="detail-modal">
    <div class="modal" style="max-width:1100px;">
        <div class="modal-header">
            <div class="modal-title" id="detail-title">Kalkulation</div>
            <button class="modal-close" onclick="closeModal('detail-modal')">‚úï</button>
        </div>
        <div class="modal-body" id="detail-body">
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal('detail-modal')">Schlie√üen</button>
            <button class="btn btn-success" onclick="generateEmail()" id="email-btn">‚úâÔ∏è E-Mail-Entwurf</button>
        </div>
    </div>
</div>

<script src="/static/js/auth.js"></script>
<script src="/static/js/app.js"></script>
<script>
checkAuth();
document.getElementById('sidebar-container').innerHTML = renderSidebar('kalkulation');

let allCalcs = [];
let currentCalcId = null;

async function loadCalcs() {
    try {
        allCalcs = await apiFetch('/api/kalkulation/');
        renderCalcs();
    } catch(e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

function renderCalcs() {
    const tbody = document.getElementById('calcs-body');
    if (allCalcs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:24px;color:#718096">Keine Kalkulationen vorhanden</td></tr>';
        return;
    }
    tbody.innerHTML = allCalcs.map(c => {
        const pct = c.platform_pct || 0;
        const barClass = pct >= 90 ? 'danger' : pct >= 70 ? 'warn' : '';
        const matLabel = c.material_group === 'IN718_IN625' ? 'IN718/IN625' : c.material_group;
        return `<tr>
            <td><strong>${c.calc_number}</strong></td>
            <td>${c.calc_name}</td>
            <td>${c.machine}</td>
            <td>${matLabel}</td>
            <td>
                <div class="platform-bar-wrap" style="min-width:80px;">
                    <div class="platform-bar-label"><span>${pct}%</span></div>
                    <div class="platform-bar-bg"><div class="platform-bar-fill ${barClass}" style="width:${Math.min(pct,100)}%"></div></div>
                </div>
            </td>
            <td>${formatEur(c.total_manual_price)}</td>
            <td>${c.total_calc_price ? formatEur(c.total_calc_price) : '‚Äî'}</td>
            <td class="${c.total_savings_eur > 0 ? 'savings-positive' : ''}">${c.total_savings_eur != null ? formatEur(c.total_savings_eur) + (c.total_savings_pct ? ` (${c.total_savings_pct}%)` : '') : '‚Äî'}</td>
            <td>${c.combined_build_time_h ? formatNum(c.combined_build_time_h, 1) : '‚Äî'}</td>
            <td>${c.end_date || '‚Äî'}</td>
            <td><span class="badge badge-${c.status === 'open' ? 'info' : 'success'}">${c.status}</span></td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-icon btn-outline btn-sm" onclick="openDetail(${c.calc_id})" title="Details">üîç</button>
                    <button class="btn btn-icon btn-danger btn-sm" onclick="deleteCalc(${c.calc_id})" title="L√∂schen">üóëÔ∏è</button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function onNewCalcMachineChange() {
    const machine = document.getElementById('nc-machine').value;
    const matSel = document.getElementById('nc-material');
    populateMaterialSelect(matSel, machine, true);

    const platform = MACHINE_PLATFORM[machine];
    if (platform) {
        document.getElementById('nc-platform').value = platform.toLocaleString('de-DE') + ' mm¬≤';
        document.getElementById('nc-platform-display').style.display = 'block';
    }
}

async function createCalc() {
    const alertEl = document.getElementById('new-calc-alert');
    const payload = {
        calc_name:      document.getElementById('nc-name').value.trim(),
        machine:        document.getElementById('nc-machine').value,
        material_group: document.getElementById('nc-material').value,
        start_date:     document.getElementById('nc-start').value || null,
        end_date:       document.getElementById('nc-end').value || null,
    };
    if (!payload.calc_name || !payload.machine || !payload.material_group) {
        alertEl.innerHTML = '<div class="alert alert-danger">Bitte alle Pflichtfelder ausf√ºllen.</div>';
        return;
    }
    try {
        const res = await apiFetch('/api/kalkulation/', { method: 'POST', body: JSON.stringify(payload) });
        showToast('Kalkulation erstellt', 'success');
        closeModal('new-calc-modal');
        loadCalcs();
        openDetail(res.calc_id);
    } catch(e) {
        alertEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
    }
}

async function openDetail(calcId) {
    currentCalcId = calcId;
    try {
        const calc = await apiFetch(`/api/kalkulation/${calcId}`);
        const matLabel = calc.material_group === 'IN718_IN625' ? 'IN718/IN625' : calc.material_group;
        document.getElementById('detail-title').textContent = `${calc.calc_number} ‚Äì ${calc.calc_name}`;

        // Get available parts
        const available = await apiFetch(`/api/kalkulation/available-parts/${calc.machine}/${calc.material_group}`);

        const pct = calc.platform_pct || 0;
        const barClass = pct >= 90 ? 'danger' : pct >= 70 ? 'warn' : '';

        let html = `
        <div class="stats-grid" style="grid-template-columns:repeat(5,1fr);margin-bottom:16px;">
            <div class="stat-card"><div class="stat-label">Maschine</div><div class="stat-value" style="font-size:16px;">${calc.machine}</div></div>
            <div class="stat-card"><div class="stat-label">Material</div><div class="stat-value" style="font-size:16px;">${matLabel}</div></div>
            <div class="stat-card"><div class="stat-label">Plattform belegt</div><div class="stat-value" style="font-size:16px;">${pct}%</div></div>
            <div class="stat-card green"><div class="stat-label">Ersparnis</div><div class="stat-value" style="font-size:16px;">${calc.total_savings_eur != null ? formatEur(calc.total_savings_eur) : '‚Äî'}</div></div>
            <div class="stat-card blue"><div class="stat-label">Bauzeit</div><div class="stat-value" style="font-size:16px;">${calc.combined_build_time_h ? formatNum(calc.combined_build_time_h, 1) + ' h' : '‚Äî'}</div></div>
        </div>
        <div class="platform-bar-wrap" style="margin-bottom:16px;">
            <div class="platform-bar-label"><span>Plattformauslastung</span><span>${pct}%</span></div>
            <div class="platform-bar-bg" style="height:12px;"><div class="platform-bar-fill ${barClass}" style="width:${Math.min(pct,100)}%"></div></div>
        </div>`;

        // Build time comparison row
        if (calc.original_build_time_h || calc.combined_build_time_h) {
            html += `<div style="display:flex;gap:24px;margin-bottom:12px;background:#f0fdf4;padding:10px 14px;border-radius:6px;font-size:13px;">
                <span>‚è±Ô∏è <strong>Orig. Bauzeit:</strong> ${calc.original_build_time_h ? formatNum(calc.original_build_time_h,1)+' h' : '‚Äî'}</span>
                <span>‚ö° <strong>Komb. Bauzeit:</strong> ${calc.combined_build_time_h ? formatNum(calc.combined_build_time_h,1)+' h' : '‚Äî'}</span>
                ${calc.original_build_time_h && calc.combined_build_time_h && calc.original_build_time_h > calc.combined_build_time_h
                    ? `<span class="savings-positive">‚úì Einsparung: ${formatNum(calc.original_build_time_h - calc.combined_build_time_h,1)} h</span>` : ''}
            </div>`;
        }

        // Parts in calculation
        if (calc.parts.length > 0) {
            html += `<div style="margin-bottom:8px;font-weight:600;font-size:14px;">Bauteile in dieser Kalkulation</div>
            <div class="table-container" style="margin-bottom:16px;">
            <table><thead><tr>
                <th>Anfragenr.</th><th>Auftragsnr.</th><th>Kundennr.</th><th>Bauteil</th>
                <th>Material</th><th>Anzahl</th><th>Orig. Preis/Stk</th>
                <th>Kalk. Preis/Stk</th><th>Ersparnis ‚Ç¨</th><th>Ersparnis %</th><th>Aktionen</th>
            </tr></thead><tbody>`;
            calc.parts.forEach(p => {
                html += `<tr>
                    <td>${p.inquiry_number || '‚Äî'}</td>
                    <td>${p.order_number || '‚Äî'}</td>
                    <td>${p.customer_number || '‚Äî'}</td>
                    <td>${p.part_name}</td>
                    <td>${p.material}</td>
                    <td>${p.quantity}</td>
                    <td>${formatEur(p.manual_part_price_eur)}</td>
                    <td>${p.calc_part_price_eur != null ? formatEur(p.calc_part_price_eur) : '<span style="color:#999">Kein Modell</span>'}</td>
                    <td class="${p.price_reduction_eur > 0 ? 'savings-positive' : ''}">${p.price_reduction_eur != null ? formatEur(p.price_reduction_eur) : '‚Äî'}</td>
                    <td class="${p.price_reduction_percent > 0 ? 'savings-positive' : ''}">${p.price_reduction_percent != null ? p.price_reduction_percent + '%' : '‚Äî'}</td>
                    <td style="display:flex;gap:4px;">
                        <button class="btn btn-outline btn-sm" onclick="openEditPartModal(${calcId}, ${p.cp_id}, ${JSON.stringify(p).replace(/"/g, '&quot;')})" title="Parameter bearbeiten">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm btn-icon" onclick="removePart(${calcId}, ${p.cp_id})">‚úï</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table></div>';
        }

        // Add parts from database
        html += `<div style="margin-bottom:8px;font-weight:600;font-size:14px;">Bauteile aus Datenbank hinzuf√ºgen</div>`;
        if (available.length === 0) {
            html += `<div class="alert alert-info">Keine kompatiblen Bauteile in der Datenbank f√ºr ${calc.machine} / ${matLabel}</div>`;
        } else {
            available.forEach(inq => {
                const alreadyAdded = calc.parts.map(p => p.part_id);
                html += `<div class="card" style="padding:10px 12px;margin-bottom:8px;box-shadow:none;border:1px solid #e2e8f0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <span><strong>${inq.inquiry_number}</strong>${inq.order_number ? ' / ' + inq.order_number : ''} ‚Äì KN: ${inq.customer_number} <span class="badge badge-${inq.status === 'Auftrag' ? 'success' : 'info'}" style="margin-left:6px;">${inq.status}</span></span>
                        <button class="btn btn-outline btn-sm" onclick="addWholeInquiry(${calcId}, ${inq.inquiry_id})">Ganze Anfrage hinzuf√ºgen</button>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;">`;
                inq.parts.forEach(p => {
                    const added = alreadyAdded.includes(p.part_id);
                    html += `<button class="btn btn-sm ${added ? 'btn-secondary' : 'btn-outline'}"
                        ${added ? 'disabled' : `onclick="addSinglePart(${calcId}, ${p.part_id})"`}
                        title="${p.part_name}">
                        ${added ? '‚úì' : '+'} ${p.part_name} (${p.quantity}√ó)
                    </button>`;
                });
                html += `</div></div>`;
            });
        }

        document.getElementById('detail-body').innerHTML = html;
        document.getElementById('detail-modal').classList.add('active');
    } catch(e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

async function addWholeInquiry(calcId, inquiryId) {
    try {
        await apiFetch(`/api/kalkulation/${calcId}/parts`, {
            method: 'POST',
            body: JSON.stringify({ part_ids: [], inquiry_id: inquiryId })
        });
        showToast('Anfrage hinzugef√ºgt', 'success');
        openDetail(calcId);
    } catch(e) { showToast(e.message, 'error'); }
}

async function addSinglePart(calcId, partId) {
    try {
        await apiFetch(`/api/kalkulation/${calcId}/parts`, {
            method: 'POST',
            body: JSON.stringify({ part_ids: [partId] })
        });
        showToast('Bauteil hinzugef√ºgt', 'success');
        openDetail(calcId);
    } catch(e) { showToast(e.message, 'error'); }
}

async function removePart(calcId, cpId) {
    try {
        await apiFetch(`/api/kalkulation/${calcId}/parts/${cpId}`, { method: 'DELETE' });
        showToast('Bauteil entfernt', 'success');
        openDetail(calcId);
        loadCalcs();
    } catch(e) { showToast(e.message, 'error'); }
}

async function deleteCalc(calcId) {
    if (!confirm('Kalkulation l√∂schen? Bauteile bleiben in der Datenbank erhalten.')) return;
    try {
        await apiFetch(`/api/kalkulation/${calcId}`, { method: 'DELETE' });
        showToast('Kalkulation gel√∂scht', 'success');
        loadCalcs();
    } catch(e) { showToast(e.message, 'error'); }
}

function openNewCalcModal() {
    document.getElementById('new-calc-alert').innerHTML = '';
    document.getElementById('nc-name').value = '';
    document.getElementById('nc-machine').value = '';
    document.getElementById('nc-material').innerHTML = '<option value="">-- erst Maschine w√§hlen --</option>';
    document.getElementById('nc-start').value = '';
    document.getElementById('nc-end').value = '';
    document.getElementById('nc-platform-display').style.display = 'none';
    document.getElementById('new-calc-modal').classList.add('active');
}

function generateEmail() {
    if (!currentCalcId) return;
    window.location.href = `/emails.html?calc_id=${currentCalcId}`;
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
    if (id === 'detail-modal') loadCalcs();
}

loadCalcs();

let editPartCalcMachine = '';

function openEditPartModal(calcId, cpId, part) {
    document.getElementById('ep-calc-id').value = calcId;
    document.getElementById('ep-cp-id').value = cpId;
    document.getElementById('edit-part-title').textContent = `${part.part_name} ‚Äì Parameter bearbeiten`;
    document.getElementById('edit-part-alert').innerHTML = '';

    // Populate material dropdown based on calc machine
    const calc = allCalcs.find(c => c.calc_id === calcId);
    const machine = calc ? calc.machine : '';
    editPartCalcMachine = machine;
    const matSel = document.getElementById('ep-material');
    matSel.innerHTML = '';
    (MACHINE_MATERIALS[machine] || []).forEach(m => {
        const opt = document.createElement('option');
        opt.value = m; opt.textContent = m;
        if (m === part.material) opt.selected = true;
        matSel.appendChild(opt);
    });

    document.getElementById('ep-quantity').value = part.quantity || 1;
    document.getElementById('ep-volume').value = part.part_volume_cm3 || '';
    document.getElementById('ep-support').value = part.support_volume_cm3 || '';
    document.getElementById('ep-height').value = part.part_height_mm || '';
    document.getElementById('ep-prep').value = part.prep_time_min || '';
    document.getElementById('ep-post').value = part.post_handling_time_min || '';
    document.getElementById('ep-blast').value = part.blasting_time_min || '';
    document.getElementById('ep-leak').value = part.leak_testing_time_min || '';
    document.getElementById('ep-qc').value = part.qc_time_min || '';
    document.getElementById('ep-stock').value = part.stock_cm3 || '';

    document.getElementById('edit-part-modal').classList.add('active');
}

async function saveEditPart() {
    const calcId = parseInt(document.getElementById('ep-calc-id').value);
    const cpId = parseInt(document.getElementById('ep-cp-id').value);

    const payload = {
        material_override:            document.getElementById('ep-material').value || null,
        quantity_override:            parseInt(document.getElementById('ep-quantity').value) || null,
        part_volume_cm3:              parseFloat(document.getElementById('ep-volume').value) || null,
        support_volume_cm3:           parseFloat(document.getElementById('ep-support').value) || null,
        part_height_mm:               parseFloat(document.getElementById('ep-height').value) || null,
        stock_cm3:                    parseFloat(document.getElementById('ep-stock').value) || null,
        prep_time_min:                parseFloat(document.getElementById('ep-prep').value) || null,
        post_handling_time_min:       parseFloat(document.getElementById('ep-post').value) || null,
        blasting_time_min:            parseFloat(document.getElementById('ep-blast').value) || null,
        leak_testing_time_min:        parseFloat(document.getElementById('ep-leak').value) || null,
        qc_time_min:                  parseFloat(document.getElementById('ep-qc').value) || null,
    };

    try {
        await apiFetch(`/api/kalkulation/${calcId}/parts/${cpId}`, {
            method: 'PUT',
            body: JSON.stringify(payload)
        });
        showToast('Bauteil aktualisiert und neu berechnet', 'success');
        closeModal('edit-part-modal');
        openDetail(calcId);
    } catch(e) {
        document.getElementById('edit-part-alert').innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
    }
}

</script>

<!-- Edit CalcPart Modal -->
<div class="modal-overlay" id="edit-part-modal">
    <div class="modal" style="max-width:640px;">
        <div class="modal-header">
            <div class="modal-title" id="edit-part-title">Bauteilparameter bearbeiten</div>
            <button class="modal-close" onclick="closeModal('edit-part-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="alert alert-info" style="font-size:12px;">Diese √Ñnderungen gelten nur f√ºr diese Kalkulation. Die Originaldaten in der Datenbank bleiben unver√§ndert.</div>
            <div id="edit-part-alert"></div>
            <input type="hidden" id="ep-calc-id">
            <input type="hidden" id="ep-cp-id">
            <div class="form-row-2">
                <div class="form-group">
                    <label class="form-label">Material</label>
                    <select class="form-control" id="ep-material"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Anzahl</label>
                    <input class="form-control" type="number" id="ep-quantity" min="1">
                </div>
            </div>
            <div class="form-row-3">
                <div class="form-group">
                    <label class="form-label">Bauteilvolumen [cm¬≥]</label>
                    <input class="form-control" type="number" step="0.01" id="ep-volume">
                </div>
                <div class="form-group">
                    <label class="form-label">St√ºtzstruktur [cm¬≥]</label>
                    <input class="form-control" type="number" step="0.01" id="ep-support">
                </div>
                <div class="form-group">
                    <label class="form-label">Bauh√∂he [mm]</label>
                    <input class="form-control" type="number" step="0.01" id="ep-height">
                </div>
            </div>
            <div class="form-row-3">
                <div class="form-group">
                    <label class="form-label">Vorbereitung [min]</label>
                    <input class="form-control" type="number" step="0.1" id="ep-prep">
                </div>
                <div class="form-group">
                    <label class="form-label">Nachbearbeitung [min]</label>
                    <input class="form-control" type="number" step="0.1" id="ep-post">
                </div>
                <div class="form-group">
                    <label class="form-label">Strahlen [min]</label>
                    <input class="form-control" type="number" step="0.1" id="ep-blast">
                </div>
            </div>
            <div class="form-row-3">
                <div class="form-group">
                    <label class="form-label">Dichtheitspr√ºfung [min]</label>
                    <input class="form-control" type="number" step="0.1" id="ep-leak">
                </div>
                <div class="form-group">
                    <label class="form-label">Qualit√§tskontrolle [min]</label>
                    <input class="form-control" type="number" step="0.1" id="ep-qc">
                </div>
                <div class="form-group">
                    <label class="form-label">Materialeinsatz [cm¬≥]</label>
                    <input class="form-control" type="number" step="0.01" id="ep-stock">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal('edit-part-modal')">Abbrechen</button>
            <button class="btn btn-primary" onclick="saveEditPart()">Speichern & neu berechnen</button>
        </div>
    </div>
</div>

</body>
</html>
