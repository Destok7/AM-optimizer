<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Anfragen ‚Äì LPBF Optimizer</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div class="app-layout">

    <nav class="sidebar">
        <div class="sidebar-logo"><h2>‚öôÔ∏è LPBF Optimizer</h2><p>Produktionsplanung</p></div>
        <div class="sidebar-nav">
            <a href="/static/dashboard.html"    class="nav-item"><span class="icon">üìä</span> Dashboard</a>
            <a href="/static/inquiry.html"       class="nav-item active"><span class="icon">üìã</span> Anfragen</a>
            <a href="/static/buildjobs.html"     class="nav-item"><span class="icon">üèóÔ∏è</span> Build-Jobs</a>
            <a href="/static/nesting.html"       class="nav-item"><span class="icon">üî≤</span> Nesting</a>
            <a href="/static/notifications.html" class="nav-item"><span class="icon">‚úâÔ∏è</span> E-Mail-Entw√ºrfe</a>
        </div>
        <div class="sidebar-footer">
            <span id="user-name"></span>
            <a href="#" onclick="logout()" style="color:rgba(255,255,255,0.4);font-size:12px;text-decoration:none;">Abmelden</a>
        </div>
    </nav>

    <div class="main-content">
        <div class="topbar">
            <h1>Anfragen & Auftr√§ge</h1>
            <div class="topbar-actions">
                <button class="btn btn-primary" onclick="showForm()">+ Neue Anfrage</button>
            </div>
        </div>
        <div class="page-body">

            <div id="alert-area"></div>

            <!-- New Inquiry Form -->
            <div class="card" id="inquiry-form" style="display:none">
                <div class="card-title">üìã Neue Anfrage erfassen</div>
                <div class="form-grid">
                    <div class="form-section-title">Identifikation</div>
                    <div class="form-group">
                        <label>Kundennummer *</label>
                        <input type="text" id="f-customer" placeholder="z.B. KD-2024-001">
                    </div>
                    <div class="form-group">
                        <label>Anfragenummer</label>
                        <input type="text" id="f-inquiry-nr" placeholder="z.B. ANF-2024/042">
                    </div>
                    <div class="form-group">
                        <label>Auftragsnummer</label>
                        <input type="text" id="f-order-nr" placeholder="z.B. AUF-2024/042">
                    </div>
                    <div class="form-group">
                        <label>Anfragename *</label>
                        <input type="text" id="f-name" placeholder="z.B. Halterung_Titan_M√§rz2025">
                    </div>
                    <div class="form-group">
                        <label>Anfragedatum</label>
                        <input type="date" id="f-date">
                    </div>

                    <div class="form-section-title">Bauteilparameter</div>
                    <div class="form-group">
                        <label>Bauteilname *</label>
                        <input type="text" id="f-part-name" placeholder="z.B. Halterung_v3">
                    </div>
                    <div class="form-group">
                        <label>Anzahl [-] *</label>
                        <input type="number" id="f-quantity" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label>Bauteilvolumen [cm¬≥] *</label>
                        <input type="number" id="f-volume" step="0.0001" placeholder="0.0000">
                    </div>
                    <div class="form-group">
                        <label>Materialeinsatz [%]</label>
                        <input type="number" id="f-stock" step="0.01" placeholder="optional">
                    </div>
                    <div class="form-group">
                        <label>St√ºtzstrukturvolumen [%] *</label>
                        <input type="number" id="f-support" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Bauh√∂he [mm] *</label>
                        <input type="number" id="f-height" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Proj. XY-Fl√§che (pro Teil) [cm¬≤]</label>
                        <input type="number" id="f-xy" step="0.0001" placeholder="f√ºr Nesting-Algorithmus">
                    </div>

                    <div class="form-section-title">Zeitparameter [h]</div>
                    <div class="form-group">
                        <label>Auftragsvorbereitung [h]</label>
                        <input type="number" id="f-prep" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Nachbearbeitung [h]</label>
                        <input type="number" id="f-handling" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Korundstrahlen [h]</label>
                        <input type="number" id="f-blasting" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Dichtheitspr√ºfung [h]</label>
                        <input type="number" id="f-leak" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Qualit√§tskontrolle [h]</label>
                        <input type="number" id="f-qc" step="0.01" placeholder="0.00">
                    </div>

                    <div class="form-section-title">Lieferzeit</div>
                    <div class="form-group">
                        <label>Gew√ºnschtes Lieferdatum</label>
                        <input type="date" id="f-delivery">
                    </div>
                    <div class="form-group">
                        <label>Lieferzeit flexibel?</label>
                        <select id="f-flexible">
                            <option value="false">Nein</option>
                            <option value="true">Ja</option>
                        </select>
                    </div>

                    <div class="form-section-title">Gesch√§tzte Werte (aus Unternehmensvorlage)</div>
                    <div class="form-group">
                        <label>St√ºckpreis [‚Ç¨]</label>
                        <input type="number" id="f-price" step="0.01" placeholder="aus interner Kalkulation">
                    </div>
                    <div class="form-group">
                        <label>Bauzeit [h]</label>
                        <input type="number" id="f-buildtime" step="0.01" placeholder="aus interner Kalkulation">
                    </div>
                </div>

                <div style="margin-top:20px;display:flex;gap:10px">
                    <button class="btn btn-primary" onclick="submitInquiry()">üíæ Anfrage speichern</button>
                    <button class="btn btn-outline" onclick="hideForm()">Abbrechen</button>
                </div>
            </div>

            <!-- Inquiries Table -->
            <div class="card">
                <div class="card-title">üìã Alle Anfragen</div>
                <div style="margin-bottom:12px;display:flex;gap:10px">
                    <select id="filter-status" onchange="loadInquiries()" style="padding:7px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px">
                        <option value="">Alle Status</option>
                        <option value="pending">Ausstehend</option>
                        <option value="combined">Kombiniert</option>
                        <option value="quoted">Angeboten</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Anfragename</th>
                                <th>Kundennr.</th>
                                <th>Anfragenr.</th>
                                <th>Bauteil</th>
                                <th>Menge</th>
                                <th>XY-Fl√§che [cm¬≤]</th>
                                <th>St√ºckpreis [‚Ç¨]</th>
                                <th>Bauzeit [h]</th>
                                <th>Lieferdatum</th>
                                <th>Status</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="inquiry-list">
                            <tr><td colspan="11" style="text-align:center;color:var(--text-muted)">Lade Daten...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="/static/js/auth.js"></script>
<script>
    requireAuth();
    setUserName();
    loadInquiries();

    function showForm() { document.getElementById('inquiry-form').style.display = 'block'; window.scrollTo(0,0); }
    function hideForm() { document.getElementById('inquiry-form').style.display = 'none'; }

    async function loadInquiries() {
        const status = document.getElementById('filter-status').value;
        const url = `/api/inquiries/${status ? '?status=' + status : ''}`;
        const res = await apiFetch(url);
        if (!res) return;
        const data = await res.json();
        const tbody = document.getElementById('inquiry-list');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:var(--text-muted)">Keine Anfragen gefunden</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(i => `
            <tr>
                <td><strong>${i.inquiry_name}</strong></td>
                <td>${i.customer_number}</td>
                <td>${i.inquiry_number || '‚Äì'}</td>
                <td>${i.part_name}</td>
                <td>${i.quantity}</td>
                <td>${i.projected_xy_surface_cm2 ? formatNumber(i.projected_xy_surface_cm2, 4) : '‚Äì'}</td>
                <td>${formatCurrency(i.estimated_part_price_eur)}</td>
                <td>${i.estimated_build_time_h ? formatNumber(i.estimated_build_time_h) : '‚Äì'}</td>
                <td>${formatDate(i.requested_delivery_date)}</td>
                <td>${statusBadge(i.status)}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteInquiry(${i.inquiry_id})">üóë</button>
                </td>
            </tr>
        `).join('');
    }

    async function submitInquiry() {
        const body = {
            customer_number:          document.getElementById('f-customer').value.trim(),
            inquiry_number:           document.getElementById('f-inquiry-nr').value.trim() || null,
            order_number:             document.getElementById('f-order-nr').value.trim() || null,
            inquiry_name:             document.getElementById('f-name').value.trim(),
            inquiry_date:             document.getElementById('f-date').value || null,
            part_name:                document.getElementById('f-part-name').value.trim(),
            quantity:                 parseInt(document.getElementById('f-quantity').value) || 1,
            part_volume_cm3:          parseFloat(document.getElementById('f-volume').value) || 0,
            stock_percent:            parseFloat(document.getElementById('f-stock').value) || null,
            support_volume_percent:   parseFloat(document.getElementById('f-support').value) || 0,
            part_height_mm:           parseFloat(document.getElementById('f-height').value) || 0,
            projected_xy_surface_cm2: parseFloat(document.getElementById('f-xy').value) || null,
            prep_time_h:              parseFloat(document.getElementById('f-prep').value) || null,
            post_handling_time_h:     parseFloat(document.getElementById('f-handling').value) || null,
            blasting_time_h:          parseFloat(document.getElementById('f-blasting').value) || null,
            leak_testing_time_h:      parseFloat(document.getElementById('f-leak').value) || null,
            qc_time_h:                parseFloat(document.getElementById('f-qc').value) || null,
            requested_delivery_date:  document.getElementById('f-delivery').value || null,
            lead_time_flexible:       document.getElementById('f-flexible').value === 'true',
            estimated_part_price_eur: parseFloat(document.getElementById('f-price').value) || null,
            estimated_build_time_h:   parseFloat(document.getElementById('f-buildtime').value) || null,
        };

        if (!body.customer_number || !body.inquiry_name || !body.part_name) {
            showAlert('alert-area', 'Bitte alle Pflichtfelder (*) ausf√ºllen.', 'error');
            return;
        }

        const res = await apiFetch('/api/inquiries/', { method: 'POST', body: JSON.stringify(body) });
        if (!res) return;
        const data = await res.json();

        if (res.ok) {
            showAlert('alert-area', 'Anfrage erfolgreich gespeichert.', 'success');
            hideForm();
            loadInquiries();
        } else {
            showAlert('alert-area', data.detail || 'Fehler beim Speichern.', 'error');
        }
    }

    async function deleteInquiry(id) {
        if (!confirm('Anfrage wirklich l√∂schen?')) return;
        const res = await apiFetch(`/api/inquiries/${id}`, { method: 'DELETE' });
        if (res && res.ok) {
            showAlert('alert-area', 'Anfrage gel√∂scht.', 'success');
            loadInquiries();
        }
    }
</script>
</body>
</html>
